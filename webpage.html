<!DOCTYPE html>
<html>
<head>
    <title>Robot Control</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial; text-align: center; margin-top: 50px; display: flex; justify-content: space-around; align-items: center; height: 100vh; }
        .button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        #joystick {
            width: 250px;  /* Increased by 25% */
            height: 250px; /* Increased by 25% */
            background-color: #ddd;
            border-radius: 50%;
            position: relative;
            touch-action: none;
        }
        #knob {
            width: 75px;  /* Increased by 25% */
            height: 75px; /* Increased by 25% */
            background-color: #4CAF50;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
    <script>
        function sendRequest(url) {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", url, true);
            xhr.send();
        }

        function buttonPress() {
            sendRequest("/press");
        }

        function buttonRelease() {
            sendRequest("/release");
        }

        function sendJoystickPosition(x, y) {
            sendRequest(`/joystick?x=${x}&y=${y}`);
        }

        function initJoystick() {
            const joystick = document.getElementById('joystick');
            const knob = document.getElementById('knob');
            const output = document.getElementById('output');
            let dragging = false;
            let lastSent = 0;

            joystick.addEventListener('mousedown', startDrag);
            joystick.addEventListener('touchstart', startDrag);

            document.addEventListener('mousemove', drag);
            document.addEventListener('touchmove', drag);

            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);

            function startDrag(event) {
                dragging = true;
                event.preventDefault();
            }

            function drag(event) {
                if (!dragging) return;
                const now = Date.now();
                if (now - lastSent < 50) return;
                lastSent = now;

                const rect = joystick.getBoundingClientRect();
                const x = (event.touches ? event.touches[0].clientX : event.clientX) - rect.left;
                const y = (event.touches ? event.touches[0].clientY : event.clientY) - rect.top;
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                const dx = x - centerX;
                const dy = y - centerY;
                const distance = Math.min(Math.sqrt(dx * dx + dy * dy), centerX);
                const angle = Math.atan2(dy, dx);
                const knobX = centerX + distance * Math.cos(angle);
                const knobY = centerY + distance * Math.sin(angle);
                knob.style.left = `${knobX}px`;
                knob.style.top = `${knobY}px`;
                const normalizedX = (knobX - centerX) / centerX;
                const normalizedY = (knobY - centerY) / centerY;
                output.textContent = `X: ${normalizedX.toFixed(2)}, Y: ${normalizedY.toFixed(2)}`;
                sendJoystickPosition(normalizedX.toFixed(2), normalizedY.toFixed(2));
            }

            function endDrag(event) {
                if (event.touches && event.touches.length > 0) return; // Prevent resetting if there are still touches
                dragging = false;
                knob.style.left = '50%';
                knob.style.top = '50%';
                output.textContent = 'X: 0.00, Y: 0.00';
                sendJoystickPosition(0.00, 0.00);
            }
        }

        window.onload = function() {
            initJoystick();
            const button = document.querySelector('.button');
            button.addEventListener('mousedown', function(event) {
                event.preventDefault();
                buttonPress();
            });
            button.addEventListener('mouseup', function(event) {
                event.preventDefault();
                buttonRelease();
            });
            button.addEventListener('touchstart', function(event) {
                event.preventDefault();
                buttonPress();
            });
            button.addEventListener('touchend', function(event) {
                event.preventDefault();
                buttonRelease();
            });
        };
    </script>
</head>
<body>
    <div id="joystick">
        <div id="knob"></div>
    </div>
    <div id="output">X: 0.00, Y: 0.00</div>
    <div>
        <button class="button" onmousedown="buttonPress()" onmouseup="buttonRelease()" ontouchstart="buttonPress()" ontouchend="buttonRelease()">Toggle LED</button>
    </div>
</body>
</html>
