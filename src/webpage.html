<!DOCTYPE html>
<html>
<head>
    <title>Robot Control</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial; text-align: center; margin-top: 50px; display: flex; justify-content: space-around; align-items: center; height: 100vh; }
        .button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 72px; /* Changed to make the button square */
            text-align: center;
            font-size: 16px;
            margin: 10px;
            cursor: pointer;
            border-radius: 8px;
        }
        .button.disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            pointer-events: none;
        }
        #joystick {
            width: 400px;  /* Increased size */
            height: 400px;
            background-color: #ddd;
            border-radius: 50%;
            position: relative;
            touch-action: none;
        }
        #knob {
            width: 120px;  /* Increased proportionally */
            height: 120px;
            background-color: #4CAF50;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        /* Add deadzone indicator */
        #deadzone {
            width: 80px;
            height: 80px;
            border: 2px dashed #999;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }
        #status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px;
            border-radius: 5px;
        }
        #status-display {
            position: fixed;
            top: 10px;
            left: 10px;
            padding: 10px;
            background: #333;
            color: white;
            border-radius: 5px;
            text-align: left;
            font-family: monospace;
        }
        
        /* Settings button and modal styles */
        .settings-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            z-index: 100;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1000;
        }
        
        .modal-content {
            position: relative;
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
        }
        
        .close {
            position: absolute;
            right: 10px;
            top: 5px;
            font-size: 24px;
            cursor: pointer;
        }
        
        .servo-setting {
            margin-bottom: 20px;
        }
        
        .input-group {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .input-group label {
            width: 120px;
            text-align: right;
            margin-right: 10px;
        }
        
        .input-group input {
            flex-grow: 1;
        }
        
        .input-group span {
            width: 50px;
            text-align: left;
            margin-left: 10px;
        }
        
        button#saveSettings {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 15px;
            text-align: center;
            font-size: 16px;
            margin-top: 10px;
            cursor: pointer;
            border-radius: 4px;
            float: right;
        }
    </style>
    <script>
        function sendCommand(url) {
            fetch(url).catch(err => console.error('Command error:', err));
        }

        function buttonPress() {
            sendCommand('/button/press');
        }

        function buttonRelease() {
            sendCommand('/button/release');
        }

        function sendJoystickPosition(x, y) {
            sendCommand(`/joystick/${x}/${y}`);
        }

        function initJoystick() {
            const joystick = document.getElementById('joystick');
            const knob = document.getElementById('knob');
            const output = document.getElementById('output');
            const button = document.querySelector('.button');
            let dragging = false;
            let lastSent = 0;
            const DEADZONE = 0.15; // 15% deadzone

            // Start with button disabled
            button.classList.add('disabled');

            function setButtonState(enabled) {
                button.classList.toggle('disabled', !enabled);
            }

            joystick.addEventListener('mousedown', startDrag);
            joystick.addEventListener('touchstart', startDrag);

            document.addEventListener('mousemove', drag);
            document.addEventListener('touchmove', drag);

            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);

            function startDrag(event) {
                dragging = true;
                setButtonState(true);  // Enable button when starting to use joystick
                event.preventDefault();
            }

            function drag(event) {
                if (!dragging) return;
                const now = Date.now();
                if (now - lastSent < 50) return;
                lastSent = now;

                const rect = joystick.getBoundingClientRect();
                const x = (event.touches ? event.touches[0].clientX : event.clientX) - rect.left;
                const y = (event.touches ? event.touches[0].clientY : event.clientY) - rect.top;
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                const dx = x - centerX;
                const dy = y - centerY;
                const distance = Math.min(Math.sqrt(dx * dx + dy * dy), centerX);
                const angle = Math.atan2(dy, dx);
                const knobX = centerX + distance * Math.cos(angle);
                const knobY = centerY + distance * Math.sin(angle);

                // Set knob position
                knob.style.left = `${knobX}px`;
                knob.style.top = `${knobY}px`;

                // Calculate normalized values with deadzone
                let normalizedX = (knobX - centerX) / centerX;
                let normalizedY = (knobY - centerY) / centerY;
                
                // Apply deadzone
                const magnitude = Math.sqrt(normalizedX * normalizedX + normalizedY * normalizedY);
                if (magnitude < DEADZONE) {
                    normalizedX = 0;
                    normalizedY = 0;
                } else {
                    // Rescale values after deadzone
                    const scale = (magnitude - DEADZONE) / (1 - DEADZONE);
                    normalizedX = (normalizedX / magnitude) * scale;
                    normalizedY = (normalizedY / magnitude) * scale;
                }

                output.textContent = `X: ${normalizedX.toFixed(2)}, Y: ${normalizedY.toFixed(2)}`;
                sendJoystickPosition(normalizedX.toFixed(2), normalizedY.toFixed(2));
            }

            function endDrag(event) {
                if (event.touches && event.touches.length > 0) return; // Prevent resetting if there are still touches
                dragging = false;
                setButtonState(false);  // Disable button when joystick is released
                knob.style.left = '50%';
                knob.style.top = '50%';
                output.textContent = 'X: 0.00, Y: 0.00';
                sendJoystickPosition(0.00, 0.00);
            }
        }

        let statusInterval;

        async function updateStatus() {
            try {
                const response = await fetch('/status');
                const status = await response.json();
                
                // Update LED status
                document.getElementById('led-status').textContent = 
                    status.led ? 'ON' : 'OFF';
                
                // Update motor speeds
                document.getElementById('left-motor').textContent = 
                    status.motors.left.toFixed(2);
                document.getElementById('right-motor').textContent = 
                    status.motors.right.toFixed(2);
            } catch (err) {
                console.error('Status error:', err);
            }
        }
        
        // Function to load servo settings from server
        async function loadServoSettings() {
            try {
                const response = await fetch('/servo/settings');
                if (response.ok) {
                    const settings = await response.json();
                    document.getElementById('servo1On').value = settings.servo1.on;
                    document.getElementById('servo1Off').value = settings.servo1.off;
                    document.getElementById('servo2On').value = settings.servo2.on;
                    document.getElementById('servo2Off').value = settings.servo2.off;
                    
                    // Update display values
                    document.getElementById('servo1OnValue').textContent = `${settings.servo1.on}Â°`;
                    document.getElementById('servo1OffValue').textContent = `${settings.servo1.off}Â°`;
                    document.getElementById('servo2OnValue').textContent = `${settings.servo2.on}Â°`;
                    document.getElementById('servo2OffValue').textContent = `${settings.servo2.off}Â°`;
                }
            } catch (err) {
                console.error('Error loading servo settings:', err);
            }
        }
        
        // Function to save servo settings to server
        async function saveServoSettings() {
            const settings = {
                servo1: {
                    on: parseInt(document.getElementById('servo1On').value),
                    off: parseInt(document.getElementById('servo1Off').value)
                },
                servo2: {
                    on: parseInt(document.getElementById('servo2On').value),
                    off: parseInt(document.getElementById('servo2Off').value)
                }
            };
            
            try {
                const response = await fetch('/servo/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settings)
                });
                
                if (response.ok) {
                    alert('Settings saved successfully!');
                    document.getElementById('settingsModal').style.display = 'none';
                } else {
                    alert('Failed to save settings: ' + await response.text());
                }
            } catch (err) {
                console.error('Error saving settings:', err);
                alert('Error saving settings: ' + err.message);
            }
        }

        window.onload = function() {
            initJoystick();
            const button = document.querySelector('.button');
            button.addEventListener('mousedown', function(event) {
                event.preventDefault();
                buttonPress();
            });
            button.addEventListener('mouseup', function(event) {
                event.preventDefault();
                buttonRelease();
            });
            button.addEventListener('touchstart', function(event) {
                event.preventDefault();
                buttonPress();
            });
            button.addEventListener('touchend', function(event) {
                event.preventDefault();
                buttonRelease();
            });
            
            // Start status polling
            statusInterval = setInterval(updateStatus, 100);
            
            // Settings modal handling
            const modal = document.getElementById('settingsModal');
            const settingsBtn = document.getElementById('settingsBtn');
            const closeBtn = document.querySelector('.close');
            const saveBtn = document.getElementById('saveSettings');
            
            // When the user clicks the settings button, open the modal
            settingsBtn.onclick = function() {
                loadServoSettings();
                modal.style.display = 'block';
            }
            
            // When the user clicks on close (X), close the modal
            closeBtn.onclick = function() {
                modal.style.display = 'none';
            }
            
            // When the user clicks the save button, save settings
            saveBtn.onclick = saveServoSettings;
            
            // When the user clicks anywhere outside the modal, close it
            window.onclick = function(event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            }
            
            // Add event listeners for slider inputs to update display values
            document.getElementById('servo1On').addEventListener('input', function() {
                document.getElementById('servo1OnValue').textContent = `${this.value}Â°`;
            });
            
            document.getElementById('servo1Off').addEventListener('input', function() {
                document.getElementById('servo1OffValue').textContent = `${this.value}Â°`;
            });
            
            document.getElementById('servo2On').addEventListener('input', function() {
                document.getElementById('servo2OnValue').textContent = `${this.value}Â°`;
            });
            
            document.getElementById('servo2Off').addEventListener('input', function() {
                document.getElementById('servo2OffValue').textContent = `${this.value}Â°`;
            });
        };

        window.onunload = function() {
            clearInterval(statusInterval);
        };
    </script>
</head>
<body>
    <button id="settingsBtn" class="settings-btn">âï¸</button>
    
    <div id="joystick">
        <div id="deadzone"></div>
        <div id="knob"></div>
    </div>
    <div id="output">X: 0.00, Y: 0.00</div>
    <div>
        <button class="button" onmousedown="buttonPress()" onmouseup="buttonRelease()" ontouchstart="buttonPress()" ontouchend="buttonRelease()"></button>
    </div>
    <div id="status-display">
        LED: <span id="led-status">OFF</span><br>
        Left Motor: <span id="left-motor">0.00</span><br>
        Right Motor: <span id="right-motor">0.00</span>
    </div>
    
    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Servo Settings</h2>
            
            <div class="servo-setting">
                <h3>Servo 1</h3>
                <div class="input-group">
                    <label for="servo1On">On Position:</label>
                    <input type="range" id="servo1On" min="0" max="180" value="0">
                    <span id="servo1OnValue">0Â°</span>
                </div>
                <div class="input-group">
                    <label for="servo1Off">Off Position:</label>
                    <input type="range" id="servo1Off" min="0" max="180" value="90">
                    <span id="servo1OffValue">90Â°</span>
                </div>
            </div>
            
            <div class="servo-setting">
                <h3>Servo 2</h3>
                <div class="input-group">
                    <label for="servo2On">On Position:</label>
                    <input type="range" id="servo2On" min="0" max="180" value="0">
                    <span id="servo2OnValue">0Â°</span>
                </div>
                <div class="input-group">
                    <label for="servo2Off">Off Position:</label>
                    <input type="range" id="servo2Off" min="0" max="180" value="90">
                    <span id="servo2OffValue">90Â°</span>
                </div>
            </div>
            
            <button id="saveSettings">Save</button>
        </div>
    </div>
</body>
</html>
